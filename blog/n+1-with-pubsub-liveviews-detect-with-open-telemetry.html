<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta content="YDokMnADSRcWHDNgPDA4XhkdQzhjHxA86em_FG3cDZt4ouW1InnH4kIP" name="csrf-token">
<title>N+1 problem by misusing Phoenix PubSub and how to spot it with OpenTelemetry.</title>
    <meta property="og:title" content="N+1 problem by misusing Phoenix PubSub and how to spot it with OpenTelemetry.">

    <meta property="og:description" content="Phoenix LiveView is awesome! Accompanied with Phoenix PubSub it provides the superpower for building interactive real-time UX. But &quot;with great power comes great responsibility&quot;. In this article we&#39;ll take a look at the problem and how to detect it with OpenTelemetry.">

    <link phx-track-static rel="stylesheet" href="/assets/app-c06800e414f5ee1a979dc219e9bc8b89.css?vsn=d">
    <script defer data-domain="manusachi.com" src="https://plausible.io/js/plausible.js"></script>
  </head>
  <body>
    <div class="min-h-screen bg-gray-50">
      <div class="mx-auto max-w-screen-xl">
<main class="pt-10 grid grid-flow-row-dense sm:grid-cols-5 grid-cols-1 grid-rows-1">
  <div class="flex flex-col items-center col-span-1 mr-6 mb-5">
    <div class="mb-6 flex items-center justify-center">
      <img src="/images/rudolf_manusachi-3bb82e361f9624566a0b775c25b45338.jpeg?vsn=d" class="rounded-full w-1/2 sm:w-9/12">
    </div>
    <div class="flex flex-col">
      <div>
        <h1 class="text-2xl mt-5 mb-3">Rudolf Manusadzhian</h1>
        <p class="italic text-sm text-right">Developing software at
          <a href="https://simplebet.io" class="text-fuchsia-600" target="_blank">Simplebet</a>
        </p>
      </div>
      <div class="mt-3 flex place-content-around">
        <div class="w-6">
          <a href="https://github.com/RudolfMan" target="_blank">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Pro 6.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg>
          </a>
        </div>

        <div class="w-6">
          <a href="https://twitter.com/RudManusachi" target="_blank">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Pro 6.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --><path d="M400 32H48C21.5 32 0 53.5 0 80v352c0 26.5 21.5 48 48 48h352c26.5 0 48-21.5 48-48V80c0-26.5-21.5-48-48-48zm-48.9 158.8c.2 2.8.2 5.7.2 8.5 0 86.7-66 186.6-186.6 186.6-37.2 0-71.7-10.8-100.7-29.4 5.3.6 10.4.8 15.8.8 30.7 0 58.9-10.4 81.4-28-28.8-.6-53-19.5-61.3-45.5 10.1 1.5 19.2 1.5 29.6-1.2-30-6.1-52.5-32.5-52.5-64.4v-.8c8.7 4.9 18.9 7.9 29.6 8.3a65.447 65.447 0 0 1-29.2-54.6c0-12.2 3.2-23.4 8.9-33.1 32.3 39.8 80.8 65.8 135.2 68.6-9.3-44.5 24-80.6 64-80.6 18.9 0 35.9 7.9 47.9 20.7 14.8-2.8 29-8.3 41.6-15.8-4.9 15.2-15.2 28-28.8 36.1 13.2-1.4 26-5.1 37.8-10.2-8.9 13.1-20.1 24.7-32.9 34z"></path></svg>
          </a>
        </div>

        <div class="w-6">
          <a href="https://www.linkedin.com/in/manusachi" target="_blank">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Pro 6.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg>
          </a>
        </div>
      </div>
    </div>
  </div>
  <div class="col-span-3">
<div id="post-n+1-with-pubsub-liveviews-detect-with-open-telemetry" class="relative mb-10 last:mb-0 px-6 pt-10 pb-8 bg-white col-start-2 col-end-6 ring-1 ring-gray-500/5 sm:rounded-lg sm:px-10">
  <div class="text-base text-gray-600">
    <h2 class="text-gray-900 text-3xl font-semibold">
      
N+1 problem by misusing Phoenix PubSub and how to spot it with OpenTelemetry.
  
    </h2>

    <div class="mt-4 mb-2">
      <p class="italic text-gray-500 text-sm mt-10">April 10, 2022</p>

  <div class="post"><blockquote>
  <h4 class="note">
TL:DR  </h4>
  <p>
The problem may occur when each PubSub subscriber does an expensive operation based on payload once an event is received that could have been done prior to broadcasting the message. Instrumentation with tracing telemetry can help to detect those.  </p>
</blockquote>
<p>
Lately I’ve been playing more with <a href="https://hexdocs.pm/phoenix_live_view/Phoenix.LiveView.html">Phoenix LiveView</a> and <a href="https://surface-ui.org">Surface-UI</a>. I enjoy building rich UI with almost no custom JS and getting more used to thinking differently about interactivity, when the state is pushed to the user from the Back-End not upon the request from the client, but upon the data update. I noticed a potential place where some sort of a N+1 problem, that I haven’t dealt with before, could appear if the developer is not careful (as with any types of N+1 problems).</p>
<p>
During the development of the LiveView UI, to quickly test the whole result, sometimes I just open 2 browser windows on the same view, change the data and see the broadcasted message pushed down to clients that didn’t interact with the UI but receive an update. And that’s when the hidden problem can occur.</p>
<h3>
A sample app with LiveView and PubSub</h3>
<p>
Let’s take a look at the example. Say, we put together a service for “ACME” to track orders and their statuses. The order status is either “placed”, “shipped” or “delivered”. All connected users should see the update once it happens.</p>
<p>
Let’s create a phoenix app:</p>
<pre><code class="shell">$ mix phx.new acme</code></pre>
<p>
and generate “Orders” context.</p>
<pre><code class="shell">$ mix phx.gen.live Orders Order orders account_id:integer status:integer</code></pre>
<p>
That task would generate for us a context with liveview to do minimal CRUD operations. Notice that status is an <code class="inline">:integer</code>. We want to use <code class="inline">Ecto.Enum</code> to map the status code to the “name”. Change the field type in the schema definition in “lib/acme/orders/order.ex”</p>
<pre><code class="makeup elixir"><span class="n">...</span><span class="w">
</span><span class="n">schema</span><span class="w"> </span><span class="s">&quot;orders&quot;</span><span class="w"> </span><span class="k" data-group-id="9903779002-1">do</span><span class="w">
  </span><span class="n">field</span><span class="w"> </span><span class="ss">:account_id</span><span class="p">,</span><span class="w"> </span><span class="ss">:integer</span><span class="w">
  </span><span class="n">field</span><span class="w"> </span><span class="ss">:status</span><span class="p">,</span><span class="w"> </span><span class="nc">Ecto.Enum</span><span class="p">,</span><span class="w"> </span><span class="ss">values</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="9903779002-2">[</span><span class="ss">placed</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">shipped</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="ss">delivered</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p" data-group-id="9903779002-2">]</span><span class="w">

  </span><span class="n">timestamps</span><span class="p" data-group-id="9903779002-3">(</span><span class="p" data-group-id="9903779002-3">)</span><span class="w">
</span><span class="k" data-group-id="9903779002-1">end</span><span class="w">
</span><span class="n">...</span></code></pre>
<p>
And let’s change the generated form input box from type “number” to “select”. In “lib/acme_web/live/order_live/form_component.html.heex” change the status field:</p>
<pre><code class="makeup elixir"><span class="n">...</span><span class="w">
</span><span class="o">&lt;</span><span class="p">%</span><span class="o">=</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="ss">:status</span><span class="w"> </span><span class="p">%</span><span class="o">&gt;</span><span class="w">
</span><span class="o">&lt;</span><span class="p">%</span><span class="o">=</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="ss">:status</span><span class="p">,</span><span class="w"> </span><span class="nc">Ecto.Enum</span><span class="o">.</span><span class="n">values</span><span class="p" data-group-id="7083925424-1">(</span><span class="nc">Orders.Order</span><span class="p">,</span><span class="w"> </span><span class="ss">:status</span><span class="p" data-group-id="7083925424-1">)</span><span class="p">,</span><span class="w"> </span><span class="ss">prompt</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Order status&quot;</span><span class="w"> </span><span class="p">%</span><span class="o">&gt;</span><span class="w">
</span><span class="o">&lt;</span><span class="p">%</span><span class="o">=</span><span class="w"> </span><span class="n">error_tag</span><span class="w"> </span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="ss">:status</span><span class="w"> </span><span class="p">%</span><span class="o">&gt;</span></code></pre>
<p>
<a href="https://github.com/RudolfMan/acme_liveview_pubsub_opentelemetry/commit/17ad5cbc0ff68040b0d8f55fb70483dafe909ce3">See diffs.</a></p>
<p>
Now let’s add some minimal <code class="inline">PubSub</code> to broadcast the updates from Orders context. Change function <code class="inline">update_order/2</code> in “/lib/acme/orders.ex” to:</p>
<pre><code class="makeup elixir"><span class="kd">def</span><span class="w"> </span><span class="nf">update_order</span><span class="p" data-group-id="5458811845-1">(</span><span class="p" data-group-id="5458811845-2">%</span><span class="nc" data-group-id="5458811845-2">Order</span><span class="p" data-group-id="5458811845-2">{</span><span class="p" data-group-id="5458811845-2">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">order</span><span class="p">,</span><span class="w"> </span><span class="n">attrs</span><span class="p" data-group-id="5458811845-1">)</span><span class="w"> </span><span class="k" data-group-id="5458811845-3">do</span><span class="w">
  </span><span class="n">order_changeset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Order</span><span class="o">.</span><span class="n">changeset</span><span class="p" data-group-id="5458811845-4">(</span><span class="n">order</span><span class="p">,</span><span class="w"> </span><span class="n">attrs</span><span class="p" data-group-id="5458811845-4">)</span><span class="w">

  </span><span class="k">with</span><span class="w"> </span><span class="p" data-group-id="5458811845-5">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">order</span><span class="p" data-group-id="5458811845-5">}</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">update</span><span class="p" data-group-id="5458811845-6">(</span><span class="n">order_changeset</span><span class="p" data-group-id="5458811845-6">)</span><span class="w"> </span><span class="k" data-group-id="5458811845-7">do</span><span class="w">
    </span><span class="nc">Phoenix.PubSub</span><span class="o">.</span><span class="n">broadcast</span><span class="p" data-group-id="5458811845-8">(</span><span class="nc">Acme.PubSub</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;orders:</span><span class="si" data-group-id="5458811845-9">#{</span><span class="n">order</span><span class="o">.</span><span class="n">id</span><span class="si" data-group-id="5458811845-9">}</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5458811845-10">{</span><span class="ss">:order_updated</span><span class="p">,</span><span class="w"> </span><span class="n">order</span><span class="p" data-group-id="5458811845-10">}</span><span class="p" data-group-id="5458811845-8">)</span><span class="w">
    </span><span class="p" data-group-id="5458811845-11">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">order</span><span class="p" data-group-id="5458811845-11">}</span><span class="w">
  </span><span class="k" data-group-id="5458811845-7">end</span><span class="w">
</span><span class="k" data-group-id="5458811845-3">end</span></code></pre>
<p>
We also need to subscribe to that topic from <code class="inline">OrderLive.Show</code>. Inside <code class="inline">handle_params/3</code> callback add:</p>
<pre><code class="makeup elixir"><span class="k">if</span><span class="w"> </span><span class="n">connected?</span><span class="p" data-group-id="8228308008-1">(</span><span class="n">socket</span><span class="p" data-group-id="8228308008-1">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="nc">Phoenix.PubSub</span><span class="o">.</span><span class="n">subscribe</span><span class="p" data-group-id="8228308008-2">(</span><span class="nc">Acme.PubSub</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;orders:</span><span class="si" data-group-id="8228308008-3">#{</span><span class="n">id</span><span class="si" data-group-id="8228308008-3">}</span><span class="s">&quot;</span><span class="p" data-group-id="8228308008-2">)</span></code></pre>
<p>
where <code class="inline">id</code> is order id.</p>
<p>
And add <code class="inline">handle_info/2</code> callback to reassign new order once broadcasted:</p>
<pre><code class="makeup elixir"><span class="kd">def</span><span class="w"> </span><span class="nf">handle_info</span><span class="p" data-group-id="8676008753-1">(</span><span class="p" data-group-id="8676008753-2">{</span><span class="ss">:order_updated</span><span class="p">,</span><span class="w"> </span><span class="n">order</span><span class="p" data-group-id="8676008753-2">}</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p" data-group-id="8676008753-1">)</span><span class="w"> </span><span class="k" data-group-id="8676008753-3">do</span><span class="w">
  </span><span class="p" data-group-id="8676008753-4">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="n">assign</span><span class="p" data-group-id="8676008753-5">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="ss">:order</span><span class="p">,</span><span class="w"> </span><span class="n">order</span><span class="p" data-group-id="8676008753-5">)</span><span class="p" data-group-id="8676008753-4">}</span><span class="w">
</span><span class="k" data-group-id="8676008753-3">end</span></code></pre>
<p>
<a href="https://github.com/RudolfMan/acme_liveview_pubsub_opentelemetry/commit/3471f617a91a9a1a5a6c04595b8579a8c7532130">See diffs.</a></p>
<p>
Now when the order is updated all users connected to <code class="inline">OrderLive.Show</code> will see the changes.</p>
<h3>
The tricky part.</h3>
<p>
It’s important to keep in mind that LiveView spawns an erlang process for each connected client.</p>
<p>
Therefore, since each of them receive the update, <code class="inline">handle_info/2</code> callback performs individually for each client. Hence, we should avoid any expensive operation, such as DB calls, remote service calls etc. in that callback.</p>
<p>
Just don’t do anything expensive in there. Sounds simple, right? However, in practice in larger systems when requirements change and multiple modules are already subscribed to particular updates - some of them eventually might require some extra info or side effects when update happens.</p>
<p>
For example, imagine that in the “ACME” a new requirement, if an order is shipped - we want to load and show the information about the shipping agency that takes care of the particular delivery. And there could be a temptation to add that code to liveview, because on first glance it seems like we just want to “show that info to viewers”.</p>
<pre><code class="makeup elixir"><span class="kd">def</span><span class="w"> </span><span class="nf">handle_info</span><span class="p" data-group-id="1196118005-1">(</span><span class="p" data-group-id="1196118005-2">{</span><span class="ss">:order_updated</span><span class="p">,</span><span class="w"> </span><span class="n">order</span><span class="p" data-group-id="1196118005-2">}</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p" data-group-id="1196118005-1">)</span><span class="w"> </span><span class="k" data-group-id="1196118005-3">do</span><span class="w">
  </span><span class="n">order</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">preload_shipping_agency</span><span class="p" data-group-id="1196118005-4">(</span><span class="n">order</span><span class="p" data-group-id="1196118005-4">)</span><span class="w">

  </span><span class="p" data-group-id="1196118005-5">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="n">assign</span><span class="p" data-group-id="1196118005-6">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="ss">:order</span><span class="p">,</span><span class="w"> </span><span class="n">order</span><span class="p" data-group-id="1196118005-6">)</span><span class="p" data-group-id="1196118005-5">}</span><span class="w">
</span><span class="k" data-group-id="1196118005-3">end</span></code></pre>
<p>
It might work fine and when testing locally. We won’t notice any issue, but it will try to preload shipping agency <code class="inline">N</code> times, where <code class="inline">N</code> is the number of connected clients.</p>
<h3>
How to detect the problem?</h3>
<p>
Overall it’s a good practice to have the project well instrumented and setup with observability. Similar to any kind of N+1 problems, this can be spotted relatively easily with tracing.</p>
<p>
Let’s see how we can instrument it with <a href="https://opentelemetry.io/">OpenTelemetry</a> and, for, at least, local development, observe traces in <a href="https://zipkin.io/">OpenZipkin</a>.</p>
<p>
In a separate terminal tab let’s start zipkin server:</p>
<pre><code class="shell">$ docker run -d -p 9411:9411 openzipkin/zipkin</code></pre>
<p>
Now let’s define required dependencies in “mix.exs”:</p>
<pre><code class="makeup elixir"><span class="kd">defp</span><span class="w"> </span><span class="nf">deps</span><span class="w"> </span><span class="k" data-group-id="0605116286-1">do</span><span class="w">
  </span><span class="p" data-group-id="0605116286-2">[</span><span class="w">
    </span><span class="n">...</span><span class="w">
    </span><span class="p" data-group-id="0605116286-3">{</span><span class="ss">:opentelemetry</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 1.0&quot;</span><span class="p" data-group-id="0605116286-3">}</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="0605116286-4">{</span><span class="ss">:opentelemetry_api</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 1.0&quot;</span><span class="p" data-group-id="0605116286-4">}</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="0605116286-5">{</span><span class="ss">:opentelemetry_ecto</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 1.0&quot;</span><span class="p" data-group-id="0605116286-5">}</span><span class="w">
    </span><span class="p" data-group-id="0605116286-6">{</span><span class="ss">:opentelemetry_phoenix</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 1.0&quot;</span><span class="p" data-group-id="0605116286-6">}</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="0605116286-7">{</span><span class="ss">:opentelemetry_zipkin</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 1.0&quot;</span><span class="p" data-group-id="0605116286-7">}</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="0605116286-2">]</span></code></pre>
<p>
setup default tracers for phoenix and ecto in “application.ex”:</p>
<pre><code class="makeup elixir"><span class="kd">def</span><span class="w"> </span><span class="nf">start</span><span class="p" data-group-id="5572945872-1">(</span><span class="c">_type</span><span class="p">,</span><span class="w"> </span><span class="c">_args</span><span class="p" data-group-id="5572945872-1">)</span><span class="w"> </span><span class="k" data-group-id="5572945872-2">do</span><span class="w">
  </span><span class="nc">OpentelemetryPhoenix</span><span class="o">.</span><span class="n">setup</span><span class="p" data-group-id="5572945872-3">(</span><span class="p" data-group-id="5572945872-3">)</span><span class="w">
  </span><span class="nc">OpentelemetryEcto</span><span class="o">.</span><span class="n">setup</span><span class="p" data-group-id="5572945872-4">(</span><span class="p" data-group-id="5572945872-5">[</span><span class="ss">:acme</span><span class="p">,</span><span class="w"> </span><span class="ss">:repo</span><span class="p" data-group-id="5572945872-5">]</span><span class="p" data-group-id="5572945872-4">)</span><span class="w">
  </span><span class="n">...</span><span class="w">
</span><span class="k" data-group-id="5572945872-2">end</span></code></pre>
<p>
And let’s also configure exporter to zipkin in either “config/dev.exs” or “config/config.exs” add:</p>
<pre><code class="makeup elixir"><span class="n">config</span><span class="w"> </span><span class="ss">:opentelemetry</span><span class="p">,</span><span class="w"> </span><span class="ss">:processors</span><span class="p">,</span><span class="w">
  </span><span class="ss">otel_batch_processor</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="2069806530-1">%{</span><span class="w">
    </span><span class="ss">exporter</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="2069806530-2">{</span><span class="ss">:opentelemetry_zipkin</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2069806530-3">%{</span><span class="ss">address</span><span class="p">:</span><span class="w"> </span><span class="sc">&#39;http://localhost:9411/api/v2/spans&#39;</span><span class="p" data-group-id="2069806530-3">}</span><span class="p" data-group-id="2069806530-2">}</span><span class="w">
  </span><span class="p" data-group-id="2069806530-1">}</span></code></pre>
<p>
<a href="https://github.com/RudolfMan/acme_liveview_pubsub_opentelemetry/commit/e83443875926b1a79a4c0af406ea5db1ff3e28d8">See diffs.</a></p>
<p>
Now let’s create traces.</p>
<p>
First we need to require <code class="inline">OpenTelemetry.Tracer</code> as it provides with macros to create spans.</p>
<pre><code class="makeup elixir"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">AcmeWeb.OrderLive.Show</span><span class="w"> </span><span class="k" data-group-id="7272691699-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">AcmeWeb</span><span class="p">,</span><span class="w"> </span><span class="ss">:live_view</span><span class="w">

  </span><span class="kn">require</span><span class="w"> </span><span class="nc">OpenTelemetry.Tracer</span><span class="w">

  </span><span class="n">...</span><span class="w">
</span></code></pre>
<p>
and update <code class="inline">handle_info/2</code> with:</p>
<pre><code class="makeup elixir"><span class="kd">def</span><span class="w"> </span><span class="nf">handle_info</span><span class="p" data-group-id="2208452329-1">(</span><span class="p" data-group-id="2208452329-2">{</span><span class="ss">:order_updated</span><span class="p">,</span><span class="w"> </span><span class="n">order</span><span class="p" data-group-id="2208452329-2">}</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p" data-group-id="2208452329-1">)</span><span class="w"> </span><span class="k" data-group-id="2208452329-3">do</span><span class="w">
  </span><span class="n">span_opts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="2208452329-4">%{</span><span class="ss">attributes</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="2208452329-5">%{</span><span class="ss">user</span><span class="p">:</span><span class="w"> </span><span class="n">inspect</span><span class="p" data-group-id="2208452329-6">(</span><span class="n">self</span><span class="p" data-group-id="2208452329-7">(</span><span class="p" data-group-id="2208452329-7">)</span><span class="p" data-group-id="2208452329-6">)</span><span class="p" data-group-id="2208452329-5">}</span><span class="p" data-group-id="2208452329-4">}</span><span class="w">

  </span><span class="nc">OpenTelemetry.Tracer</span><span class="o">.</span><span class="n">with_span</span><span class="w"> </span><span class="s">&quot;order_live.show:order_updated&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">span_opts</span><span class="w"> </span><span class="k" data-group-id="2208452329-8">do</span><span class="w">
    </span><span class="c1"># expensive operation like DB call, service call.. etc.</span><span class="w">
    </span><span class="nc">Process</span><span class="o">.</span><span class="n">sleep</span><span class="p" data-group-id="2208452329-9">(</span><span class="mi">70</span><span class="p" data-group-id="2208452329-9">)</span><span class="w">

    </span><span class="p" data-group-id="2208452329-10">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="n">assign</span><span class="p" data-group-id="2208452329-11">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="ss">:order</span><span class="p">,</span><span class="w"> </span><span class="n">order</span><span class="p" data-group-id="2208452329-11">)</span><span class="p" data-group-id="2208452329-10">}</span><span class="w">
  </span><span class="k" data-group-id="2208452329-8">end</span><span class="w">
</span><span class="k" data-group-id="2208452329-3">end</span></code></pre>
<p>
For the purpose of the example we pretend that each viewer-user is represented by its live_view pid. We add <code class="inline">:user</code> attribute to differentiate between spans created for each user.</p>
<p>
<a href="https://github.com/RudolfMan/acme_liveview_pubsub_opentelemetry/commit/efb4cea542578c8e32fd6d6fcb4ebe47b0bb0446">See diffs.</a></p>
<p>
Set the env variable <code class="inline">OTEL_SERVICE_NAME</code> and start the server like:</p>
<pre><code class="shell">OTEL_SERVICE_NAME=acme iex -S mix phx.server</code></pre>
<p>
Now if we try to trigger a broadcast to multiple connected windows - we should see in Zipkin UI multiple spans created.</p>
<p>
However, as you notice, spans are not part of the same trace, because the span context by default is local for the erlang process, while, as mentioned earlier, each LiveView connection lives in its own process. In order to overcome this we could start a span when an update happens, and pass its context as part of the broadcasted event message. In <code class="inline">Acme.Orders</code> update <code class="inline">update_order/2</code> to be like:</p>
<pre><code class="makeup elixir"><span class="kd">def</span><span class="w"> </span><span class="nf">update_order</span><span class="p" data-group-id="5652163919-1">(</span><span class="p" data-group-id="5652163919-2">%</span><span class="nc" data-group-id="5652163919-2">Order</span><span class="p" data-group-id="5652163919-2">{</span><span class="p" data-group-id="5652163919-2">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">order</span><span class="p">,</span><span class="w"> </span><span class="n">attrs</span><span class="p" data-group-id="5652163919-1">)</span><span class="w"> </span><span class="k" data-group-id="5652163919-3">do</span><span class="w">
  </span><span class="nc">OpenTelemetry.Tracer</span><span class="o">.</span><span class="n">with_span</span><span class="w"> </span><span class="s">&quot;orders:update_order&quot;</span><span class="w"> </span><span class="k" data-group-id="5652163919-4">do</span><span class="w">
    </span><span class="n">order_changeset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Order</span><span class="o">.</span><span class="n">changeset</span><span class="p" data-group-id="5652163919-5">(</span><span class="n">order</span><span class="p">,</span><span class="w"> </span><span class="n">attrs</span><span class="p" data-group-id="5652163919-5">)</span><span class="w">

    </span><span class="k">with</span><span class="w"> </span><span class="p" data-group-id="5652163919-6">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">order</span><span class="p" data-group-id="5652163919-6">}</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">update</span><span class="p" data-group-id="5652163919-7">(</span><span class="n">order_changeset</span><span class="p" data-group-id="5652163919-7">)</span><span class="w"> </span><span class="k" data-group-id="5652163919-8">do</span><span class="w">
      </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">OpenTelemetry.Tracer</span><span class="o">.</span><span class="n">current_span_ctx</span><span class="p" data-group-id="5652163919-9">(</span><span class="p" data-group-id="5652163919-9">)</span><span class="w">
      </span><span class="nc">Phoenix.PubSub</span><span class="o">.</span><span class="n">broadcast</span><span class="p" data-group-id="5652163919-10">(</span><span class="nc">Acme.PubSub</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;orders:</span><span class="si" data-group-id="5652163919-11">#{</span><span class="n">order</span><span class="o">.</span><span class="n">id</span><span class="si" data-group-id="5652163919-11">}</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5652163919-12">{</span><span class="ss">:order_updated</span><span class="p">,</span><span class="w"> </span><span class="n">order</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p" data-group-id="5652163919-12">}</span><span class="p" data-group-id="5652163919-10">)</span><span class="w">

      </span><span class="p" data-group-id="5652163919-13">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">order</span><span class="p" data-group-id="5652163919-13">}</span><span class="w">
    </span><span class="k" data-group-id="5652163919-8">end</span><span class="w">
  </span><span class="k" data-group-id="5652163919-4">end</span><span class="w">
</span><span class="k" data-group-id="5652163919-3">end</span></code></pre>
<p>
And in the <code class="inline">OrderLive.Show.handle_info/2</code> set the span context:</p>
<pre><code class="makeup elixir"><span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_info</span><span class="p" data-group-id="0262467880-1">(</span><span class="p" data-group-id="0262467880-2">{</span><span class="ss">:order_updated</span><span class="p">,</span><span class="w"> </span><span class="n">order</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p" data-group-id="0262467880-2">}</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p" data-group-id="0262467880-1">)</span><span class="w"> </span><span class="k" data-group-id="0262467880-3">do</span><span class="w">
    </span><span class="nc">OpenTelemetry.Tracer</span><span class="o">.</span><span class="n">set_current_span</span><span class="p" data-group-id="0262467880-4">(</span><span class="n">ctx</span><span class="p" data-group-id="0262467880-4">)</span><span class="w">

    </span><span class="n">opts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="0262467880-5">%{</span><span class="ss">attributes</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="0262467880-6">%{</span><span class="ss">user</span><span class="p">:</span><span class="w"> </span><span class="n">inspect</span><span class="p" data-group-id="0262467880-7">(</span><span class="n">self</span><span class="p" data-group-id="0262467880-8">(</span><span class="p" data-group-id="0262467880-8">)</span><span class="p" data-group-id="0262467880-7">)</span><span class="p" data-group-id="0262467880-6">}</span><span class="p" data-group-id="0262467880-5">}</span><span class="w">

    </span><span class="nc">OpenTelemetry.Tracer</span><span class="o">.</span><span class="n">with_span</span><span class="w"> </span><span class="s">&quot;order_live.show:order_updated&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">opts</span><span class="w"> </span><span class="k" data-group-id="0262467880-9">do</span><span class="w">
      </span><span class="c1"># expensive operation like DB call, service call.. etc.</span><span class="w">
      </span><span class="nc">Process</span><span class="o">.</span><span class="n">sleep</span><span class="p" data-group-id="0262467880-10">(</span><span class="mi">70</span><span class="p" data-group-id="0262467880-10">)</span><span class="w">

      </span><span class="p" data-group-id="0262467880-11">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="n">assign</span><span class="p" data-group-id="0262467880-12">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="ss">:order</span><span class="p">,</span><span class="w"> </span><span class="n">order</span><span class="p" data-group-id="0262467880-12">)</span><span class="p" data-group-id="0262467880-11">}</span><span class="w">
    </span><span class="k" data-group-id="0262467880-9">end</span><span class="w">
  </span><span class="k" data-group-id="0262467880-3">end</span></code></pre>
<p>
<a href="https://github.com/RudolfMan/acme_liveview_pubsub_opentelemetry/commit/8f26d9687d56ec7a308c596b7520cf075a2fe43b">See diffs.</a></p>
<p>
Now when we trigger broadcast, a single trace with multiple spans occurs in Zipkin UI.</p>
<p>
  <img src="/images/zipkin_n_1.png" alt="N+1 problem Phoenix LiveView PubSub OpenTelemetry" />
</p>
<p>
That’s it in a nutshell!</p>
<p>
The code with calls to OpenTelemetry everywhere looks boilerplaty, but this should be enough to make it work.</p>
<h3>
Thoughts on how to make it beautiful.</h3>
<p>
One thing comes to mind is to create a helper for broadcasting, that would wrap the event into a struct where it would also pass the OpenTelemetry context.
Let’s create a module <code class="inline">Acme.PubSub</code>:</p>
<pre><code class="makeup elixir"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Acme.PubSub</span><span class="w"> </span><span class="k" data-group-id="4222383757-1">do</span><span class="w">
  </span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Event</span><span class="w"> </span><span class="k" data-group-id="4222383757-2">do</span><span class="w">
    </span><span class="kd">defstruct</span><span class="w"> </span><span class="p" data-group-id="4222383757-3">[</span><span class="ss">:message</span><span class="p">,</span><span class="w"> </span><span class="ss">:span_ctx</span><span class="p" data-group-id="4222383757-3">]</span><span class="w">
  </span><span class="k" data-group-id="4222383757-2">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">broadcast</span><span class="p" data-group-id="4222383757-4">(</span><span class="n">topic</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p" data-group-id="4222383757-4">)</span><span class="w"> </span><span class="k" data-group-id="4222383757-5">do</span><span class="w">
    </span><span class="kn">require</span><span class="w"> </span><span class="nc">OpenTelemetry.Tracer</span><span class="w">

    </span><span class="nc">OpenTelemetry.Tracer</span><span class="o">.</span><span class="n">with_span</span><span class="w"> </span><span class="s">&quot;acme.pubsub:broadcast&quot;</span><span class="w"> </span><span class="k" data-group-id="4222383757-6">do</span><span class="w">
      </span><span class="n">event</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="4222383757-7">%</span><span class="nc" data-group-id="4222383757-7">Event</span><span class="p" data-group-id="4222383757-7">{</span><span class="ss">message</span><span class="p">:</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="ss">span_ctx</span><span class="p">:</span><span class="w"> </span><span class="nc">OpenTelemetry.Tracer</span><span class="o">.</span><span class="n">current_span_ctx</span><span class="p" data-group-id="4222383757-8">(</span><span class="p" data-group-id="4222383757-8">)</span><span class="p" data-group-id="4222383757-7">}</span><span class="w">
      </span><span class="nc">Phoenix.PubSub</span><span class="o">.</span><span class="n">broadcast</span><span class="p" data-group-id="4222383757-9">(</span><span class="bp">__MODULE__</span><span class="p">,</span><span class="w"> </span><span class="n">topic</span><span class="p">,</span><span class="w"> </span><span class="n">event</span><span class="p" data-group-id="4222383757-9">)</span><span class="w">
    </span><span class="k" data-group-id="4222383757-6">end</span><span class="w">
  </span><span class="k" data-group-id="4222383757-5">end</span><span class="w">
</span><span class="k" data-group-id="4222383757-1">end</span></code></pre>
<p>
New let’s update <code class="inline">Orders.update_order/2</code> to use our new custom broadcast function:</p>
<pre><code class="makeup elixir"><span class="kd">def</span><span class="w"> </span><span class="nf">update_order</span><span class="p" data-group-id="7600523659-1">(</span><span class="p" data-group-id="7600523659-2">%</span><span class="nc" data-group-id="7600523659-2">Order</span><span class="p" data-group-id="7600523659-2">{</span><span class="p" data-group-id="7600523659-2">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">order</span><span class="p">,</span><span class="w"> </span><span class="n">attrs</span><span class="p" data-group-id="7600523659-1">)</span><span class="w"> </span><span class="k" data-group-id="7600523659-3">do</span><span class="w">
  </span><span class="n">order_changeset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Order</span><span class="o">.</span><span class="n">changeset</span><span class="p" data-group-id="7600523659-4">(</span><span class="n">order</span><span class="p">,</span><span class="w"> </span><span class="n">attrs</span><span class="p" data-group-id="7600523659-4">)</span><span class="w">

  </span><span class="k">with</span><span class="w"> </span><span class="p" data-group-id="7600523659-5">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">order</span><span class="p" data-group-id="7600523659-5">}</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">update</span><span class="p" data-group-id="7600523659-6">(</span><span class="n">order_changeset</span><span class="p" data-group-id="7600523659-6">)</span><span class="w"> </span><span class="k" data-group-id="7600523659-7">do</span><span class="w">
    </span><span class="nc">Acme.PubSub</span><span class="o">.</span><span class="n">broadcast</span><span class="p" data-group-id="7600523659-8">(</span><span class="s">&quot;orders:</span><span class="si" data-group-id="7600523659-9">#{</span><span class="n">order</span><span class="o">.</span><span class="n">id</span><span class="si" data-group-id="7600523659-9">}</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7600523659-10">{</span><span class="ss">:order_updated</span><span class="p">,</span><span class="w"> </span><span class="n">order</span><span class="p" data-group-id="7600523659-10">}</span><span class="p" data-group-id="7600523659-8">)</span><span class="w">

    </span><span class="p" data-group-id="7600523659-11">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">order</span><span class="p" data-group-id="7600523659-11">}</span><span class="w">
  </span><span class="k" data-group-id="7600523659-7">end</span><span class="w">
</span><span class="k" data-group-id="7600523659-3">end</span></code></pre>
<p>
Now, for the subscriber side we would want to “unwrap” that struct, set a context and pass the message down to the module to handle it normally. That could be done via code injection:</p>
<p>
Let’s add to <code class="inline">Acme.PubSub</code> macro <code class="inline">__using__</code>:</p>
<pre><code class="makeup elixir"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Acme.PubSub</span><span class="w"> </span><span class="k" data-group-id="8996698704-1">do</span><span class="w">
  </span><span class="n">...</span><span class="w">

  </span><span class="kd">defmacro</span><span class="w"> </span><span class="nf">__using__</span><span class="p" data-group-id="8996698704-2">(</span><span class="c">_opts</span><span class="p" data-group-id="8996698704-2">)</span><span class="w"> </span><span class="k" data-group-id="8996698704-3">do</span><span class="w">
    </span><span class="k">quote</span><span class="w"> </span><span class="k" data-group-id="8996698704-4">do</span><span class="w">
      </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_info</span><span class="p" data-group-id="8996698704-5">(</span><span class="p" data-group-id="8996698704-6">%</span><span class="nc" data-group-id="8996698704-6">Acme.PubSub.Event</span><span class="p" data-group-id="8996698704-6">{</span><span class="p" data-group-id="8996698704-6">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">event</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p" data-group-id="8996698704-5">)</span><span class="w"> </span><span class="k" data-group-id="8996698704-7">do</span><span class="w">
        </span><span class="nc">OpenTelemetry.Tracer</span><span class="o">.</span><span class="n">set_current_span</span><span class="p" data-group-id="8996698704-8">(</span><span class="n">event</span><span class="o">.</span><span class="n">span_ctx</span><span class="p" data-group-id="8996698704-8">)</span><span class="w">
        </span><span class="n">handle_info</span><span class="p" data-group-id="8996698704-9">(</span><span class="n">event</span><span class="o">.</span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p" data-group-id="8996698704-9">)</span><span class="w">
      </span><span class="k" data-group-id="8996698704-7">end</span><span class="w">
    </span><span class="k" data-group-id="8996698704-4">end</span><span class="w">
  </span><span class="k" data-group-id="8996698704-3">end</span><span class="w">
</span><span class="k" data-group-id="8996698704-1">end</span></code></pre>
<p>
and <code class="inline">use Acme.PubSub</code> in <code class="inline">OrderLive.Show</code></p>
<pre><code class="makeup elixir"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">AcmeWeb.OrderLive.Show</span><span class="w"> </span><span class="k" data-group-id="6200558376-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">AcmeWeb</span><span class="p">,</span><span class="w"> </span><span class="ss">:live_view</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Acme.PubSub</span><span class="w">
  </span><span class="n">...</span><span class="w">
</span><span class="k" data-group-id="6200558376-1">end</span></code></pre>
<p>
Now we could remove all OpenTelemetry relate boilerplate from <code class="inline">handle_info/2</code>:</p>
<pre><code class="makeup elixir"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">AcmeWeb.OrderLive.Show</span><span class="w"> </span><span class="k" data-group-id="0177841032-1">do</span><span class="w">
  </span><span class="n">...</span><span class="w">

  </span><span class="na">@impl</span><span class="w"> </span><span class="no">true</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_info</span><span class="p" data-group-id="0177841032-2">(</span><span class="p" data-group-id="0177841032-3">{</span><span class="ss">:order_updated</span><span class="p">,</span><span class="w"> </span><span class="n">order</span><span class="p" data-group-id="0177841032-3">}</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p" data-group-id="0177841032-2">)</span><span class="w"> </span><span class="k" data-group-id="0177841032-4">do</span><span class="w">
    </span><span class="c1"># expensive operation like DB call, service call.. etc.</span><span class="w">
    </span><span class="c1"># for the example we&#39;ll do a function call that results in DB query, which is already instrumented via OpenTelemetryEcto</span><span class="w">
    </span><span class="n">order</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Orders</span><span class="o">.</span><span class="n">get_order!</span><span class="p" data-group-id="0177841032-5">(</span><span class="n">order</span><span class="o">.</span><span class="n">id</span><span class="p" data-group-id="0177841032-5">)</span><span class="w">

    </span><span class="p" data-group-id="0177841032-6">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="n">assign</span><span class="p" data-group-id="0177841032-7">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="ss">:order</span><span class="p">,</span><span class="w"> </span><span class="n">order</span><span class="p" data-group-id="0177841032-7">)</span><span class="p" data-group-id="0177841032-6">}</span><span class="w">
  </span><span class="k" data-group-id="0177841032-4">end</span><span class="w">

  </span><span class="n">...</span><span class="w">
</span><span class="k" data-group-id="0177841032-1">end</span></code></pre>
<p>
<a href="https://github.com/RudolfMan/acme_liveview_pubsub_opentelemetry/commit/bb4b16f56ac8b1db84d42c5757754f44a7110e3c">See diffs.</a></p>
<p>
Much cleaner, isn’t it? However, some more information about what module causes N+1 and where broadcast was made from would be helpful to find out the source of the problem.</p>
<p>
We could “inject” that info into spans and still have relatively clean code using macros:</p>
<p>
Let’s convert our <code class="inline">Acme.PubSub.broadcast/2</code> into macro:</p>
<pre><code class="makeup elixir"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Acme.PubSub</span><span class="w"> </span><span class="k" data-group-id="9910021213-1">do</span><span class="w">
  </span><span class="n">...</span><span class="w">

  </span><span class="kd">defmacro</span><span class="w"> </span><span class="nf">broadcast</span><span class="p" data-group-id="9910021213-2">(</span><span class="n">topic</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p" data-group-id="9910021213-2">)</span><span class="w"> </span><span class="k" data-group-id="9910021213-3">do</span><span class="w">
    </span><span class="k">quote</span><span class="w"> </span><span class="k" data-group-id="9910021213-4">do</span><span class="w">
      </span><span class="n">current_function</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Acme.PubSub</span><span class="o">.</span><span class="n">current_function</span><span class="p" data-group-id="9910021213-5">(</span><span class="bp">__ENV__</span><span class="p" data-group-id="9910021213-5">)</span><span class="w">
      </span><span class="nc">Acme.PubSub</span><span class="o">.</span><span class="n">broadcast_from_function</span><span class="p" data-group-id="9910021213-6">(</span><span class="k">unquote</span><span class="p" data-group-id="9910021213-7">(</span><span class="n">topic</span><span class="p" data-group-id="9910021213-7">)</span><span class="p">,</span><span class="w"> </span><span class="k">unquote</span><span class="p" data-group-id="9910021213-8">(</span><span class="n">message</span><span class="p" data-group-id="9910021213-8">)</span><span class="p">,</span><span class="w"> </span><span class="n">current_function</span><span class="p" data-group-id="9910021213-6">)</span><span class="w">
    </span><span class="k" data-group-id="9910021213-4">end</span><span class="w">
  </span><span class="k" data-group-id="9910021213-3">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">broadcast_from_function</span><span class="p" data-group-id="9910021213-9">(</span><span class="n">topic</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">function_name</span><span class="p" data-group-id="9910021213-9">)</span><span class="w"> </span><span class="k" data-group-id="9910021213-10">do</span><span class="w">
    </span><span class="kn">require</span><span class="w"> </span><span class="nc">OpenTelemetry.Tracer</span><span class="w">

    </span><span class="n">opts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="9910021213-11">%{</span><span class="ss">attributes</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="9910021213-12">%{</span><span class="ss">broadcaster</span><span class="p">:</span><span class="w"> </span><span class="n">function_name</span><span class="p" data-group-id="9910021213-12">}</span><span class="p" data-group-id="9910021213-11">}</span><span class="w">

    </span><span class="nc">OpenTelemetry.Tracer</span><span class="o">.</span><span class="n">with_span</span><span class="w"> </span><span class="s">&quot;acme.pubsub:broadcast&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">opts</span><span class="w"> </span><span class="k" data-group-id="9910021213-13">do</span><span class="w">
      </span><span class="n">event</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="9910021213-14">%</span><span class="nc" data-group-id="9910021213-14">Event</span><span class="p" data-group-id="9910021213-14">{</span><span class="ss">message</span><span class="p">:</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="ss">otel_ctx</span><span class="p">:</span><span class="w"> </span><span class="nc">OpenTelemetry.Tracer</span><span class="o">.</span><span class="n">current_span_ctx</span><span class="p" data-group-id="9910021213-15">(</span><span class="p" data-group-id="9910021213-15">)</span><span class="p" data-group-id="9910021213-14">}</span><span class="w">
      </span><span class="nc">Phoenix.PubSub</span><span class="o">.</span><span class="n">broadcast</span><span class="p" data-group-id="9910021213-16">(</span><span class="bp">__MODULE__</span><span class="p">,</span><span class="w"> </span><span class="n">topic</span><span class="p">,</span><span class="w"> </span><span class="n">event</span><span class="p" data-group-id="9910021213-16">)</span><span class="w">
    </span><span class="k" data-group-id="9910021213-13">end</span><span class="w">
  </span><span class="k" data-group-id="9910021213-10">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">current_function</span><span class="p" data-group-id="9910021213-17">(</span><span class="n">env</span><span class="p" data-group-id="9910021213-17">)</span><span class="w"> </span><span class="k" data-group-id="9910021213-18">do</span><span class="w">
    </span><span class="p" data-group-id="9910021213-19">{</span><span class="n">fun</span><span class="p">,</span><span class="w"> </span><span class="n">arity</span><span class="p" data-group-id="9910021213-19">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">env</span><span class="o">.</span><span class="n">function</span><span class="w">
    </span><span class="s">&quot;</span><span class="si" data-group-id="9910021213-20">#{</span><span class="n">inspect</span><span class="p" data-group-id="9910021213-21">(</span><span class="n">env</span><span class="o">.</span><span class="n">module</span><span class="p" data-group-id="9910021213-21">)</span><span class="si" data-group-id="9910021213-20">}</span><span class="s">.</span><span class="si" data-group-id="9910021213-22">#{</span><span class="n">fun</span><span class="si" data-group-id="9910021213-22">}</span><span class="s">/</span><span class="si" data-group-id="9910021213-23">#{</span><span class="n">arity</span><span class="si" data-group-id="9910021213-23">}</span><span class="s">&quot;</span><span class="w">
  </span><span class="k" data-group-id="9910021213-18">end</span><span class="w">
</span><span class="k" data-group-id="9910021213-1">end</span></code></pre>
<p>
This macro <code class="inline">broadcast/3</code> gets the current function name from where it’s used, and calls <code class="inline">Acme.PubSub.broadcast_from_function/3</code> which does the same as the previous <code class="inline">broadcast/2</code> function did but also sets the <code class="inline">:broadcaster</code> attribute.</p>
<p>
Because <code class="inline">Acme.PubSub.broadcast/2</code> now is a macro we just need to <code class="inline">require</code> the <code class="inline">Acme.PubSub</code> in <code class="inline">Acme.Orders</code> before using it:</p>
<pre><code class="makeup elixir"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Acme.Orders</span><span class="w"> </span><span class="k" data-group-id="6600078722-1">do</span><span class="w">
  </span><span class="n">...</span><span class="w">
  </span><span class="kn">require</span><span class="w"> </span><span class="nc">Acme.PubSub</span><span class="w">
  </span><span class="n">...</span><span class="w">
</span><span class="k" data-group-id="6600078722-1">end</span></code></pre>
<p>
Similarly we could add info about the module that handles the broadcasted event. Let’s add a span with <code class="inline">:handler</code> attribute to injecting <code class="inline">handle_info/2</code> that would suggest the name of the handler process:</p>
<pre><code class="makeup elixir"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Acme.PubSub</span><span class="w"> </span><span class="k" data-group-id="1812639911-1">do</span><span class="w">
  </span><span class="n">...</span><span class="w">
  </span><span class="kd">defmacro</span><span class="w"> </span><span class="nf">__using__</span><span class="p" data-group-id="1812639911-2">(</span><span class="c">_opts</span><span class="p" data-group-id="1812639911-2">)</span><span class="w"> </span><span class="k" data-group-id="1812639911-3">do</span><span class="w">
    </span><span class="k">quote</span><span class="w"> </span><span class="k" data-group-id="1812639911-4">do</span><span class="w">
      </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_info</span><span class="p" data-group-id="1812639911-5">(</span><span class="p" data-group-id="1812639911-6">%</span><span class="nc" data-group-id="1812639911-6">Acme.PubSub.Event</span><span class="p" data-group-id="1812639911-6">{</span><span class="p" data-group-id="1812639911-6">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">event</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p" data-group-id="1812639911-5">)</span><span class="w"> </span><span class="k" data-group-id="1812639911-7">do</span><span class="w">
        </span><span class="kn">require</span><span class="w"> </span><span class="nc">OpenTelemetry.Tracer</span><span class="w">

        </span><span class="nc">OpenTelemetry.Tracer</span><span class="o">.</span><span class="n">set_current_span</span><span class="p" data-group-id="1812639911-8">(</span><span class="n">event</span><span class="o">.</span><span class="n">span_ctx</span><span class="p" data-group-id="1812639911-8">)</span><span class="w">
        </span><span class="n">opts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="1812639911-9">%{</span><span class="ss">attributes</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="1812639911-10">%{</span><span class="ss">handler</span><span class="p">:</span><span class="w"> </span><span class="n">inspect</span><span class="p" data-group-id="1812639911-11">(</span><span class="bp">__ENV__</span><span class="o">.</span><span class="n">module</span><span class="p" data-group-id="1812639911-11">)</span><span class="p" data-group-id="1812639911-10">}</span><span class="p" data-group-id="1812639911-9">}</span><span class="w">

        </span><span class="nc">OpenTelemetry.Tracer</span><span class="o">.</span><span class="n">with_span</span><span class="w"> </span><span class="s">&quot;acme:handle_event&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">opts</span><span class="w"> </span><span class="k" data-group-id="1812639911-12">do</span><span class="w">
          </span><span class="n">handle_info</span><span class="p" data-group-id="1812639911-13">(</span><span class="n">event</span><span class="o">.</span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p" data-group-id="1812639911-13">)</span><span class="w">
        </span><span class="k" data-group-id="1812639911-12">end</span><span class="w">
      </span><span class="k" data-group-id="1812639911-7">end</span><span class="w">
    </span><span class="k" data-group-id="1812639911-4">end</span><span class="w">
  </span><span class="k" data-group-id="1812639911-3">end</span><span class="w">
  </span><span class="n">...</span><span class="w">
</span><span class="k" data-group-id="1812639911-1">end</span></code></pre>
<p>
<a href="https://github.com/RudolfMan/acme_liveview_pubsub_opentelemetry/commit/0bd9edbf5dae1c3e9774f48ebfde29407dd9bb2d">See diffs.</a></p>
<p>
  <img src="/images/zipkin_n_1_with_attrs.png" alt="N+1 problem Phoenix LiveView PubSub OpenTelemetry Trace With Attributes" />
</p>
<p>
Voilà! 🎉</p>
<p>
Thank you for reading!</p>
</div>

  <p class="text-gray-500 italic">
    See a mistake, or would like to propose an improvement? Please, open a PR to edit the article on <a class="underline" href="https://github.com/RudolfMan/blog_posts/blob/master/2022/04-10-n+1-with-pubsub-liveviews-detect-with-open-telemetry.md">Github</a>
  </p>
    </div>
  </div>

  <div class="text-base leading-7 font-semibold">
    <p class="text-fuchsia-500 hover:text-fuchsia-600">
      
<a data-phx-link="redirect" data-phx-link-state="push" href="/blog">Back</a>
  
    </p>
  </div>
</div>

  <script src="https://giscus.app/client.js" data-repo="rudolfman/blog_posts" data-repo-id="R_kgDOG_b4ZA" data-category="Announcements" data-category-id="DIC_kwDOG_b4ZM4COT9Q" data-mapping="title" data-reactions-enabled="0" data-emit-metadata="0" data-input-position="bottom" data-theme="light" data-lang="en" crossorigin="anonymous" async>
</script>
  </div>
</main>
      </div>
    </div>
  </body>
</html>